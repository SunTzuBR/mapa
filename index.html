<!DOCTYPE html>
<html>
<head>
  <title>Mapa</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #logo {
      position: absolute;
      height: 30px;
      width: 50px;
      top: 20px;
      left: 700px;
    }
    .legend {
      position: absolute;
      bottom: 30px;
      right: 10px;
      width: 20px;
      height: 200px;
      background: linear-gradient(to top, #01afe7, #6495ED, #6A5ACD, #483D8B, #000080, #000033);
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
    }
    .pointer {
      position: absolute;
      left: 0px;
      width: 30px;
      height: 2px;
      border-radius: 10px;
      background: black;
    }
    #info {
      position: absolute;
      background-color: white;
      padding: 10px;
      border: 1px solid black;
      border-radius: 5px;
      display: none; /* Initially hidden */
      max-width: 250px;
    }
    #info-content {
      margin-bottom: 10px;
    }
    .edit-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .edit-button:hover {
      background-color: #45a049;
    }
    .edit-button:disabled {
      background-color: #c0c0c0;
      cursor: not-allowed;
    }
    .leaflet-control-attribution {
      display: none;
    }
    .leaflet-clickable {
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="legend">
  <div id="pointer" class="pointer"></div>
  <div id="popup"></div>
</div>
<div id="logo">
  <img src="logo.png" alt="Logo da Empresa">
</div>
<div id="info">
  <div id="info-content"></div>
  <button id="edit-button" class="edit-button" style="display: none;">Editar</button>
  <button id="save-button" class="edit-button" style="display: none;">Salvar</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  const geojsonUrl = 'AL.json';

  function style(feature) {
    const atendimentos = feature.properties.ATENDIMENTOS || 0;
    let fillColor, color = 'white', dashArray = null;
    if (atendimentos === 0) {
      fillColor = '#ffffff';
      color = 'black';
      dashArray = '3';
    } else if (atendimentos < 50) {
      fillColor = '#01afe7';
    } else if (atendimentos < 100) {
      fillColor = '#6495ED';
    } else if (atendimentos < 200) {
      fillColor = '#6A5ACD';
    } else if (atendimentos < 300) {
      fillColor = '#483D8B';
    } else if (atendimentos < 400) {
      fillColor = '#000080';
    } else {
      fillColor = '#000033';
    }
    return {
      fillColor: fillColor,
      weight: 1,
      opacity: 1,
      color: color,
      fillOpacity: 0.8,
      dashArray: dashArray
    };
  }

  function onMouseOver(e) {
    const layer = e.target;
    const properties = layer.feature.properties;
    const atendimentos = properties.ATENDIMENTOS || 0;
    layer.bindTooltip(`<strong>${properties.NM_MUNICIP}</strong><br>Número de Atendimentos: ${atendimentos}`).openTooltip();
    updatePointer(atendimentos);

    const popup = document.getElementById('popup');
    popup.style.display = 'block';
    popup.style.left = `${pointer.offsetLeft - popup.offsetWidth - 3}px`;
    popup.style.top = `${pointer.offsetTop + pointer.offsetHeight / 2}px`;
    popup.textContent = `${atendimentos}`;

    layer.setStyle({
      weight: 3,
      color: 'yellow',
      dashArray: null,
      fillOpacity: 0.9
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
      layer.bringToFront();
    }
  }

  function onMouseOut(e) {
    const layer = e.target;
    layer.closeTooltip();
    resetHighlight(layer);

    const popup = document.getElementById('popup');
    popup.style.display = 'none';
  }

  function onClick(e) {
    const properties = e.target.feature.properties;
    const atendimentos = properties.ATENDIMENTOS || 0;
    const infoDiv = document.getElementById('info');
    const infoContent = document.getElementById('info-content');
    const editButton = document.getElementById('edit-button');
    const saveButton = document.getElementById('save-button');

    // Mostrar informações e botão de edição
    infoDiv.style.display = 'block';
    infoDiv.style.left = `${e.originalEvent.pageX + 10}px`;
    infoDiv.style.top = `${e.originalEvent.pageY + 10}px`;

    infoContent.innerHTML = `
      <h3>${properties.NM_MUNICIP}</h3>
      <p><strong>Número de Atendimentos:</strong> <input type="number" id="atendimentos-input" value="${atendimentos}" /></p>
      <p><strong>ID:</strong> ${properties.ID}</p>
      <p><strong>Coordenadas:</strong> ${properties.CD_GEOCODM}</p>
    `;

    editButton.style.display = 'inline';
    saveButton.style.display = 'inline';

    // Desativa o botão de edição se o modo de edição estiver ativo
    editButton.disabled = true;
    saveButton.onclick = () => saveEdits(properties.ID);
  }

  function saveEdits(id) {
    const newAtendimentos = parseInt(document.getElementById('atendimentos-input').value, 10);

    fetch('/updateAtendimentos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        id: id,
        newAtendimentos: newAtendimentos
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        // Atualizar o valor na camada
        const layer = findLayerById(id);
        if (layer) {
          layer.feature.properties.ATENDIMENTOS = newAtendimentos;
          layer.setStyle(style(layer.feature));
        }
        document.getElementById('info').style.display = 'none';
      } else {
        alert('Failed to update data');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to update data');
    });
  }

  function findLayerById(id) {
    let foundLayer = null;
    map.eachLayer(layer => {
      if (layer.feature && layer.feature.properties.ID === id) {
        foundLayer = layer;
      }
    });
    return foundLayer;
  }

  function updatePointer(value, isLegend = false) {
    const min = 0;
    const max = 500;
    const range = max - min;
    const percentage = (value - min) / range;
    const pointer = document.getElementById('pointer');
    const popup = document.getElementById('popup');
    const topPosition = (1 - percentage) * 100;
    pointer.style.top = `${topPosition}%`;
    pointer.dataset.value = value;

    if (isLegend) {
      popup.textContent = `≈ ${Math.round(value)}`;
    } else {
      popup.textContent = ` ${Math.round(value)}`;
    }
  }

  var map = L.map('map', {
    center: [-9.5733, -36.7820],
    zoom: 8,
    layers: [],
    maxBounds: [
      [-11, -39],
      [-7, -34]
    ],
    maxBoundsViscosity: 2.0
  });

  fetch(geojsonUrl)
    .then(response => response.json())
    .then(data => {
      L.geoJSON(data, {
        style: style,
        onEachFeature: function(feature, layer) {
          layer.on({
            mouseover: onMouseOver,
            mouseout: onMouseOut,
            click: onClick
          });
        }
      }).addTo(map);
    });

  document.addEventListener('DOMContentLoaded', () => {
    const pointer = document.getElementById('pointer');
    const popup = document.getElementById('popup');
    const legend = document.querySelector('.legend');
    
    legend.addEventListener('mousemove', (e) => {
      const legendHeight = legend.clientHeight;
      const mouseY = e.clientY - legend.getBoundingClientRect().top;
      const value = ((legendHeight - mouseY) / legendHeight) * 500;
      updatePointer(value, true);

      highlightSimilarValues(value);
      
      popup.style.display = 'block';
      popup.style.left = `${pointer.offsetLeft - popup.offsetWidth - 3}px`;
      popup.style.top = `${pointer.offsetTop + pointer.offsetHeight / 2}px`;
    });

    legend.addEventListener('mouseleave', () => {
      popup.style.display = 'none';
      resetHighlight();
    });
    
    updatePointer(250, true);
  });

  function highlightSimilarValues(value) {
    map.eachLayer(layer => {
      if (layer.feature) {
        const atendimentos = layer.feature.properties.ATENDIMENTOS || 0;
        if (Math.abs(atendimentos - value) < 10) {
          layer.setStyle({ weight: 3, color: 'yellow' });
        } else {
          layer.setStyle(style(layer.feature));
        }
      }
    });
  }

  function resetHighlight(layer) {
    if (layer) {
      layer.setStyle(style(layer.feature));
    } else {
      map.eachLayer(l => {
        if (l.feature) {
          l.setStyle(style(l.feature));
        }
      });
    }
  }
</script>

</body>
</html>
